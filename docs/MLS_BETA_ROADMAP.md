# Meiso MLS Beta Roadmap: PoC → Beta版への移行計画

## 📋 データ構造の整理

### 現在のアーキテクチャ

1. **個人TODO（日付ベース）**
   - **Nostr**: Kind 30078（NIP-44暗号化）
   - **用途**: Today/Tomorrow/Somedayのタスク
   - **同期**: ✅ 実装済み

2. **個人カスタムリスト**
   - **ストレージ**: ローカル（Hive）のみ
   - **例**: BRAIN DUMP, GROCERY, WISHLIST, NOSTR, WORK
   - **同期**: ❌ Nostr同期は未実装
   - **影響**: kind: 30001廃止の影響を**受けない**
   - **将来**: Phase 9以降で別Kind（Kind 10030等）での同期を検討

3. **グループリスト**
   - **旧実装**: Kind 30001（NIP-51）← **廃止予定**
   - **新実装**: MLS + Kind 30078（NIP-44）
   - **影響**: kind: 30001廃止で旧実装のみが使えなくなる

### kind: 30001廃止の影響範囲

| データ | 影響 | 理由 |
|--------|------|------|
| 個人TODO | ✅ 影響なし | Kind 30078で管理 |
| 個人カスタムリスト | ✅ 影響なし | ローカルストレージ管理 |
| グループリスト（旧） | ❌ 廃止 | fiatjaf方式 → MLSへ移行 |
| グループリスト（新） | ✅ 継続 | MLS実装 |

**結論**: kind: 30001廃止は**グループリストの旧実装のみ**に影響。個人機能は一切影響なし。

---

## 現在の状況（2025-11-11）

### ✅ 完了済み: Option B PoC + Phase 1-7

#### Phase 1-4: MLS基盤 + 2人グループテスト ✅
- Rust側MLS実装（OpenMLS統合）
- Flutter側MLS統合
- MLS統合テストUI
- 2人グループ機能（Key Package生成、グループ作成、TODO暗号化）

#### Phase 5: 実デバイス間での2人グループテスト ✅
- **完了日**: 2025-11-11
- Alice ↔ Bob間でのKey Package交換
- グループ作成・招待受信
- MLSグループ参加成功
- リスト詳細画面への自動遷移

#### Phase 6: アプリ内完結型招待システム ✅
- **6.1**: Key Package公開（Kind 10443）✅
- **6.2**: npubからKey Package自動取得 ✅
- **6.3**: グループ招待通知送信（Kind 30078）✅
- **6.4**: SOMEDAYリスト表示UI（インビテーション対応）✅
- **6.5**: 招待受諾ダイアログ + 自動遷移 ✅

#### Phase 7: Amberモード動作確認 ✅
- 全テストAmberモードで実施
- 実デバイス間での完全動作確認済み

---

## 🎯 Phase 8: Beta版への移行（新定義）

**目的**: PoCから実用レベルのBeta版へ昇格

**期間**: 2-3週間

### 8.1 アプリ内招待システムの完全自動化

**現状**: MLSテストダイアログで手動操作が必要

**Beta版要件**:
1. **通常のグループリスト作成フローへの統合**
   - `AddGroupListDialog`からMLS招待システムを利用
   - npub入力だけでKey Package自動取得
   - Welcome Message自動送信

2. **自動Key Package管理**
   - アプリ起動時にKey Packageを自動公開/更新
   - 有効期限管理（30日ごとに自動更新）
   - バックグラウンド公開

3. **招待フロー改善**
   - Alice: 「グループリスト作成」→ メンバーのnpub入力 → 自動招待
   - Bob: アプリ起動 → 自動で招待表示 → タップして参加

**実装タスク**:
- [ ] `CustomListsNotifier.createGroupList()`をMLS対応に拡張
- [ ] Key Package自動公開（起動時 + 定期更新）
- [ ] `AddGroupListDialog`でnpub入力 → KP自動取得
- [ ] Welcome Message自動送信（NIP-17経由）
- [ ] 招待通知の自動同期（Pull-to-refresh不要に）

---

### 8.2 エラーハンドリングと安定性

**現状**: エラー処理が各所に散在、一貫性がない

**Beta版要件**:
1. **ネットワークエラー対応**
   - リレー接続失敗時のフォールバック
   - タイムアウト処理
   - リトライロジック

2. **MLS固有エラー対応**
   - NoMatchingKeyPackage → 再取得フロー
   - PendingCommit → 自動解決
   - 状態不整合 → 自動修復

3. **ユーザーフィードバック**
   - エラーメッセージの分かりやすさ
   - ローディング状態の明確化
   - 成功/失敗の通知

4. **オフライン対応**
   - ローカルデータのフォールバック
   - 接続回復時の自動同期
   - オフライン状態の明示

**実装タスク**:
- [ ] エラーハンドリングの統一（Result型パターン）
- [ ] リトライロジック実装（指数バックオフ）
- [ ] ユーザー向けエラーメッセージ改善
- [ ] オフライン対応（ローカルファースト）
- [ ] MLS固有エラーの自動復旧ロジック

---

### 8.3 TODO送受信機能の完全実装

**現状**: グループ参加までは成功、TODO共有は未実装

**Beta版要件**:
1. **MLSグループでのTODO暗号化送信**
   - グループリスト内でTODO作成
   - 自動的にMLS暗号化
   - listen_key（Export Secret）で送信

2. **MLSグループからのTODO受信**
   - リレーから暗号化TODO取得
   - MLS復号化
   - ローカルDB保存
   - リアルタイム表示

3. **同期ロジック**
   - バックグラウンド自動同期
   - 楽観的UI更新
   - 競合解決

**実装タスク**:
- [ ] `TodosNotifier.addTodo()`でグループ判定
- [ ] MLS暗号化送信フロー統合
- [ ] listen_key購読ロジック実装
- [ ] MLS復号化 → ローカル保存
- [ ] リアルタイム同期

---

### 8.4 グループリストの統合

**現状**:
- **MLSグループ**: 新実装、招待システム有り
- **kind: 30001グループ**: 旧実装（fiatjaf方式）、pタグ管理
- **個人カスタムリスト**: ローカルストレージ管理（影響なし）

**課題**:
- 2つの異なるグループシステムが共存（MLS vs kind: 30001）
- 検証スクリプトで確認されたkind: 30001グループが同期されない
- ユーザー体験が一貫していない

**重要**: kind: 30001廃止の影響範囲
- ✅ **影響なし**: 個人カスタムリスト（BRAIN DUMP, GROCERY等）
  - 現状: ローカルストレージ管理
  - 将来: Phase 9以降でNostr同期を検討
- ✅ **影響なし**: 個人TODO（Kind 30078で管理）
- ❌ **廃止対象**: グループリストの旧実装（fiatjaf方式）のみ

**Beta版要件**:
1. **統一されたグループ体験**
   - すべてのグループがMLS招待システムを使用
   - kind: 30001は廃止（または互換性レイヤー実装）
   
2. **グループ種別の判定**
   - `CustomList.isGroup = true` → MLSグループ
   - `CustomList.groupMembers` → メンバーリスト
   
3. **既存グループのマイグレーション**
   - 旧kind: 30001グループをMLSに移行
   - またはkind: 30001を読み取り専用で表示

**実装タスク**:
- [ ] MLSグループをデフォルトに設定
- [ ] kind: 30001グループの同期ロジック削除/無効化
- [ ] 既存グループの扱いを決定
  - Option A: MLSに自動マイグレーション
  - Option B: 読み取り専用として表示
  - Option C: 互換性レイヤー実装（複雑、非推奨）

**注意**: 
- 現在はPoC段階のため、kind: 30001ユーザーはいない
- 急ぐ必要なし、Phase 8の最後で問題なし

---

### 8.5 パフォーマンス最適化

**Beta版要件**:
1. **MLS DB最適化**
   - 初期化タイミングの最適化
   - キャッシュ戦略
   - バックグラウンド処理

2. **Key Package管理効率化**
   - 定期更新のバックグラウンド化
   - 不要なKP削除
   - ストレージ圧縮

3. **同期効率化**
   - バッチ処理
   - 差分同期
   - 帯域幅最適化

**実装タスク**:
- [ ] MLS DB初期化の遅延ロード
- [ ] Key Package定期更新のバックグラウンド化
- [ ] 同期処理のバッチ化
- [ ] メモリ使用量の最適化

---

### 8.6 テストとドキュメント

**Beta版要件**:
1. **統合テスト**
   - 3人以上のグループテスト
   - マルチデバイス同期テスト
   - ストレステスト（大量TODO）

2. **ユーザードキュメント**
   - グループリスト作成方法
   - 招待の受け方
   - トラブルシューティング

3. **開発者ドキュメント**
   - MLSアーキテクチャ説明
   - API仕様
   - デバッグ方法

**実装タスク**:
- [ ] 3人グループテスト実施
- [ ] マルチデバイステスト
- [ ] ユーザーガイド作成
- [ ] API仕様書作成

---

## 📊 Phase 8完了条件

### 必須要件（Must Have）
- ✅ 通常のグループリスト作成フローからMLS招待が使える
- ✅ Key Package自動管理（手動操作不要）
- ✅ TODO送受信が完全に動作
- ✅ MLSグループとkind: 30001の統合/廃止完了
- ✅ エラーハンドリング完備
- ✅ 3人グループでの動作確認

### 推奨要件（Should Have）
- ✅ バックグラウンド同期
- ✅ オフライン対応
- ✅ パフォーマンス最適化
- ✅ ユーザードキュメント

### 将来検討（Nice to Have）
- ⏸️ Option A移行（完全なKeychat実装移植）
- ⏸️ グループ管理機能（メンバー追加/削除）
- ⏸️ グループ権限管理
- ⏸️ メッセージ履歴管理

---

## 🗓️ タイムライン

### Week 1: 統合とエラーハンドリング（8.1, 8.2）
- Day 1-2: `AddGroupListDialog`統合
- Day 3-4: Key Package自動管理
- Day 5-7: エラーハンドリング統一とオフライン対応

### Week 2: TODO送受信実装（8.3）
- Day 1-3: 暗号化送信フロー
- Day 4-5: 復号化受信フロー
- Day 6-7: 同期ロジック実装

### Week 3: 統合と最適化（8.4, 8.5, 8.6）
- Day 1-2: グループリスト統合（kind: 30001廃止）
- Day 3-4: パフォーマンス最適化
- Day 5-7: 統合テストとドキュメント

---

## 🎯 成功指標

### 技術的指標
- MLSテストダイアログ不要（通常フローで完結）
- Key Package管理が完全自動
- TODO送受信成功率 > 99%
- 平均応答時間 < 2秒

### UX指標
- グループリスト作成が3ステップ以内
- 招待受諾が1タップで完了
- エラー発生時に分かりやすいメッセージ
- オフラインでも基本操作可能

---

## 📝 今後の課題

### Option A移行の判断（Phase 9?）

**移行する場合**:
- メリット: Production Readyな完全実装
- デメリット: 実装コスト高、TODOアプリには過剰？

**現状維持の場合**:
- メリット: シンプル、メンテナンスしやすい
- デメリット: スケーラビリティに制限

**判断基準**:
- ユーザー数（1グループあたり何人？）
- 機能要件（メンバー管理の頻度は？）
- 開発リソース

**推奨**: Phase 8完了後、ユーザーフィードバックを元に判断

---

## 🎉 まとめ

### PoC → Beta版への移行

**PoC（現状）**:
- ✅ MLSの技術検証完了
- ✅ 2人グループ動作確認
- ✅ 基本的な招待フロー実装

**Beta版（Phase 8完了後）**:
- ✅ 通常フローで使える
- ✅ 手動操作不要
- ✅ TODO送受信完全動作
- ✅ エラーハンドリング完備
- ✅ 実用レベルの安定性

**Phase 8完了 = Beta版リリース可能！**

