# Issue #39: SOCKS5プロキシ設定機能の実装

## 概要

Issue #39「Tor経由で接続の部分で、socks5プロキシのポートナンバーとプロキシアドレスが設定できないため、設定できるようにする」を解決しました。

## 実装日

2025-11-05

## 問題点

従来の実装では：
- プロキシURL（`socks5://127.0.0.1:9050`）がハードコードされていた
- ユーザーがプロキシのホストやポートを変更できなかった
- プロキシ接続が正常に動作しているか確認する手段がなかった

## 解決策

### 1. プロキシURL設定ダイアログの追加

ユーザーがプロキシのホストとポートを個別に設定できるダイアログを実装しました。

**機能**:
- ホスト入力フィールド（例: `127.0.0.1`）
- ポート入力フィールド（例: `9050`）
- バリデーション機能
  - ホスト空欄チェック
  - ポート番号範囲チェック（1-65535）
- 現在の設定値の自動パース
- 一般的な設定例の表示（Orbot: 127.0.0.1:9050）

### 2. プロキシ接続状態インジケーターの実装

プロキシが正常に動作しているか視覚的に確認できる機能を追加しました。

**接続状態**:
- 🔵 **未テスト** (グレー) - まだテストしていない
- 🟠 **テスト中** (オレンジ) - 接続テスト実行中
- 🟢 **接続成功** (グリーン) - プロキシ接続が確立
- 🔴 **接続失敗** (レッド) - プロキシに接続できない

**UI要素**:
- カラフルなステータスカード
- 状態に応じたアイコン表示
- ステータスメッセージ
- 「テスト」ボタン（手動接続テスト）
- ローディングインジケーター（テスト中）

### 3. プロキシ接続テスト機能

Socket接続を使用してプロキシの疎通確認を行う機能を実装しました。

**技術仕様**:
- タイムアウト: 3秒
- プロトコル: TCP Socket接続
- テスト対象: 設定されたプロキシのホストとポート
- 自動テスト: Tor有効化時に自動実行
- 手動テスト: 「テスト」ボタンから実行可能

## 実装詳細

### 新規ファイル

#### 1. `lib/providers/proxy_status_provider.dart`

プロキシ接続状態を管理するProvider。

```dart
enum ProxyConnectionStatus {
  unknown,    // 未テスト
  testing,    // テスト中
  connected,  // 接続成功
  failed,     // 接続失敗
}

class ProxyStatusNotifier extends StateNotifier<ProxyConnectionStatus> {
  /// プロキシ接続をテスト
  Future<void> testProxyConnection() async {
    // Socket接続テスト（タイムアウト3秒）
    final socket = await Socket.connect(host, port, timeout: Duration(seconds: 3));
    // ...
  }
}
```

**主要メソッド**:
- `testProxyConnection()` - プロキシ接続テスト実行
- `reset()` - 状態をリセット

### 変更ファイル

#### 1. `lib/presentation/settings/app_settings_detail_screen.dart`

**追加メソッド**:

##### `_showProxyUrlDialog()`

プロキシURL編集ダイアログを表示。

- ホストとポートを個別に入力
- バリデーション実施
- 保存時に`socks5://host:port`形式で保存

##### `_buildProxyStatusIndicator()`

プロキシ接続状態インジケーターを構築。

- 状態に応じた色とアイコンを表示
- テストボタンを配置
- レスポンシブなUI

**UI変更**:

1. **プロキシURL設定項目の追加**（Tor有効時のみ表示）
   ```dart
   ListTile(
     title: Text('プロキシアドレスとポート'),
     subtitle: Text(settings.proxyUrl),
     trailing: Icon(Icons.edit),
     onTap: () => _showProxyUrlDialog(...),
   )
   ```

2. **接続状態インジケーターの追加**
   - カラフルなステータスカード
   - リアルタイム更新
   - テストボタン

3. **自動接続テストの実装**
   ```dart
   ref.listen<AsyncValue<AppSettings>>(appSettingsProvider, (previous, next) {
     if (nextSettings?.torEnabled == true) {
       // 自動的にプロキシテストを実行
       ref.read(proxyStatusProvider.notifier).testProxyConnection();
     }
   });
   ```

## UI/UX

### アプリ設定画面の構成

```
┌─────────────────────────────────────┐
│ Tor経由で接続 (Orbot)      [🛡️] [ON] │
├─────────────────────────────────────┤
│ 📡 プロキシアドレスとポート     [✏️]  │
│ socks5://127.0.0.1:9050            │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 🟢 プロキシ接続状態              │ │
│ │    接続成功          [テスト]   │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### プロキシ設定ダイアログ

```
┌─────────────────────────────────────┐
│ プロキシ設定                         │
├─────────────────────────────────────┤
│ SOCKS5プロキシのアドレスとポートを   │
│ 設定してください                     │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ ホスト                           │ │
│ │ 127.0.0.1                       │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ ポート                           │ │
│ │ 9050                            │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 一般的な設定:                        │
│ • Orbot: 127.0.0.1:9050            │
│ • カスタムプロキシ: ホストとポート   │
│                                     │
│           [キャンセル] [保存]        │
└─────────────────────────────────────┘
```

## 使用方法

### 1. プロキシURL設定の変更

1. 設定画面を開く
2. 「Tor経由で接続 (Orbot)」をONにする
3. 「プロキシアドレスとポート」をタップ
4. ホストとポートを入力
5. 「保存」をタップ

### 2. プロキシ接続テスト

#### 自動テスト
- Torを有効にすると自動的にテスト実行

#### 手動テスト
1. 接続状態インジケーターの「テスト」ボタンをタップ
2. 結果が色とアイコンで表示される

### 3. 一般的なプロキシ設定

#### Orbot（デフォルト）
- ホスト: `127.0.0.1`
- ポート: `9050`

#### カスタムSOCKS5プロキシ
- ホスト: プロキシサーバーのIPアドレス
- ポート: プロキシサーバーのポート番号

## 技術仕様

### プロキシURL形式

```
socks5://[host]:[port]
```

例:
- `socks5://127.0.0.1:9050` (Orbot)
- `socks5://192.168.1.100:1080` (カスタムプロキシ)

### バリデーション

1. **ホスト**:
   - 必須入力
   - IPアドレスまたはホスト名

2. **ポート**:
   - 必須入力
   - 数値のみ
   - 範囲: 1-65535

### 接続テスト

```dart
try {
  final socket = await Socket.connect(
    host,
    port,
    timeout: Duration(seconds: 3),
  );
  await socket.close();
  // 接続成功
} on SocketException {
  // 接続失敗
} on TimeoutException {
  // タイムアウト
}
```

## セキュリティ

### データの保存

- プロキシURL設定は`AppSettings`に保存
- NIP-78（Kind 30078）経由でNostrに同期
- NIP-44暗号化により保護

### プライバシー

- プロキシテストはローカルのみ
- プロキシURLは暗号化されて同期
- 接続テストは最小限の通信のみ

## 制限事項

### 現在のバージョン

1. **プロトコル**: SOCKS5のみサポート（HTTP/HTTPSプロキシは未対応）
2. **認証**: プロキシ認証は未実装
3. **テスト範囲**: Socket接続のみ（実際のNostr通信はテストしない）

### 将来の拡張

1. **認証サポート**: ユーザー名/パスワード認証
2. **プロトコル拡張**: HTTP/HTTPSプロキシサポート
3. **高度なテスト**: 実際のリレー接続テスト
4. **プロファイル機能**: 複数のプロキシ設定を保存

## トラブルシューティング

### 接続失敗時

**症状**: 🔴 接続失敗と表示される

**原因**:
1. Orbotが起動していない
2. プロキシのホスト/ポートが間違っている
3. ファイアウォールがブロックしている

**対処法**:
1. Orbotアプリを起動してTorに接続
2. プロキシ設定を確認（ホスト: 127.0.0.1, ポート: 9050）
3. ファイアウォール設定を確認

### テストが永遠に続く

**症状**: 🟠 テスト中... のまま変わらない

**原因**: アプリが異常状態

**対処法**:
1. アプリを再起動
2. プロキシ設定を確認

## テスト項目

### 基本機能
- [x] プロキシURL設定ダイアログの表示
- [x] ホスト入力と保存
- [x] ポート入力と保存
- [x] バリデーション機能
- [x] プロキシURL形式の生成

### 接続テスト
- [x] Orbot起動時の接続成功
- [x] Orbot未起動時の接続失敗
- [x] タイムアウト処理（3秒）
- [x] 手動テストボタン
- [x] 自動テスト（Tor有効時）

### UI/UX
- [x] 接続状態インジケーター表示
- [x] 色とアイコンの変更
- [x] ローディングインジケーター
- [x] スナックバー通知

### エッジケース
- [x] 無効なホスト入力
- [x] 無効なポート入力（範囲外）
- [x] 空欄入力
- [x] Tor無効時のUI非表示

## ファイル変更一覧

### 新規作成
- `lib/providers/proxy_status_provider.dart` - プロキシ状態管理Provider
- `docs/ISSUE_39_PROXY_CONFIGURATION_FIX.md` - このドキュメント

### 変更
- `lib/presentation/settings/app_settings_detail_screen.dart`
  - `_showProxyUrlDialog()` メソッド追加
  - `_buildProxyStatusIndicator()` メソッド追加
  - プロキシURL設定UIを追加
  - 接続状態インジケーターを追加
  - 自動接続テストのリスナー追加

## 関連Issue

- Issue #39: Tor経由で接続の部分で、socks5プロキシのポートナンバーとプロキシアドレスが設定できないため、設定できるようにする

## 関連ドキュメント

- [TOR_ORBOT_SUPPORT_COMPLETE.md](TOR_ORBOT_SUPPORT_COMPLETE.md) - Tor/Orbotサポート実装

## まとめ

Issue #39を解決し、以下を実装しました：

1. ✅ **プロキシURL設定機能**
   - ホストとポートを個別に設定可能
   - バリデーション機能付き
   - Nostrに同期

2. ✅ **接続状態インジケーター**
   - 色とアイコンで視覚的に表示
   - リアルタイム更新
   - 4つの状態（未テスト/テスト中/成功/失敗）

3. ✅ **プロキシ接続テスト機能**
   - Socket接続による疎通確認
   - 自動テスト（Tor有効時）
   - 手動テスト（ボタンから実行）
   - タイムアウト処理（3秒）

ユーザーは好きなSOCKS5プロキシを設定でき、接続状態を視覚的に確認できるようになりました。Orbotだけでなく、カスタムプロキシサーバーも使用可能です。

